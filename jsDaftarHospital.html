<script>
    /**
     * @type {Array<Array<any>> | undefined} dataAsal - Data asal yang diterima dari Google Sheets.
     * Setiap elemen dalam array luar mewakili satu rekod hospital.
     * Struktur dalaman setiap rekod (array dalam):
     * [0]: ID Hospital
     * [1]: Kunci
     * [2]: Nama Hospital
     * [3]: Laman Sesawang (boleh jadi undefined)
     * [4]: Pautan Panduan (boleh jadi undefined)
     * [5]: Alamat
     * [6]: Emel
     * [7]: Tel Pejabat
     * [8]: MS ISO 15189 (boolean, true jika diakreditasi)
     * [9]: MSQH (boolean, true jika diakreditasi)
     * [10]: Tarikh kemas kini terakhir
     */
    let dataAsal;


    /**
     * Event listener yang dijalankan apabila DOM telah dimuat sepenuhnya.
     * Ia memanggil fungsi `ambilData` dari skrip Google Apps
     * melalui `google.script.run` dan menggunakan `simpanData` sebagai
     * success handler untuk memproses data yang dikembalikan.
     */
    document.addEventListener('DOMContentLoaded', () => {
        google.script.run.withSuccessHandler(simpanData).ambilData(true, false, false);
    })


    /**
     * Membina jadual pendaftaran hospital berdasarkan data yang disimpan dalam
     * `dataAsal`. Ia akan mencari elemen dengan ID "badan-jadual-daftar-hospital"
     * dan mengisi baris-baris jadual dengan data hospital.
     */
    function binaJadualDaftarHospital() {
        // Dapatkan elemen tbody jadual untuk diisi dengan data.
        const badanJadual = ambil("badan-jadual-daftar-hospital");

        // Ambil data hospital daripada pembolehubah global dataAsal.
        const data = dataAsal;
        data.sort()

        // Iterasi melalui setiap rekod hospital dalam data.
        data.forEach(rekod => {
            // Cipta elemen baris jadual (<tr>).
            let baris = buat('tr');

            // Cipta elemen sel jadual (<td>) untuk setiap lajur.
            let lajurNama = buat('td');
            let lajurAlamat = buat('td');
            let lajurAkre = buat('td');
            let lajurTarikh = buat('td');

            // Dapatkan nama hospital daripada rekod.
            let nama = rekod[2];
            // Jika terdapat pautan laman web hospital, jadikan nama sebagai pautan.
            let namaLink = rekod[3]? nama.link(rekod[3]) : nama;

            // Teks untuk pautan buku panduan.
            let panduan = "[ Buku Panduan ]";
            // Jika terdapat pautan buku panduan, jadikan teks sebagai pautan.
            let panduanLink = panduan.link(rekod[4]);

            // Set kandungan sel nama. Jika terdapat pautan panduan, gabungkan nama dan pautan panduan.
            lajurNama.innerHTML = rekod[4]? namaLink + '</br>' + panduanLink : namaLink;
            
            // Gabungkan bahagian-bahagian alamat yang tidak kosong dengan pemisah <br>.
            lajurAlamat.innerHTML = [rekod[5], rekod[6], rekod[7]].filter(Boolean).join('</br>');

            // Teks untuk jenis akreditasi.
            let iso = "MS ISO 15189";
            let msqh = "MSQH";

            // Tentukan kandungan sel akreditasi berdasarkan status akreditasi.
            let akre = (rekod[8] && rekod[9])? iso + '</br>' + msqh
                : rekod[8]? iso
                : rekod[9]? msqh
                : "-";
            
            // Set kandungan sel akreditasi.
            lajurAkre.innerHTML = akre;

            // Set kandungan sel tarikh kemas kini.
            lajurTarikh.innerHTML = rekod[10] + '</br>';

            // Tambah butang ubah selepas tarikh dalam setiap sel tarikh kemas kini.
            // Butang ubah mengandungi maklumat ID Hospital.
            // Butang ubah akan mengaktifkan modal Daftar Hospital.
            butang_ubah = buat('button');
            butang_ubah.innerHTML = "Ubah";
            butang_ubah.dataset.idHospital = rekod[0];
            butang_ubah.setAttribute("type", "button");
            butang_ubah.setAttribute("class", "btn btn-outline-warning");
            butang_ubah.setAttribute("data-bs-toggle", "modal");
            butang_ubah.setAttribute("data-bs-target", "#modalDaftarHospital")
            butang_ubah.addEventListener("click", e => paparkanDataHospital(e.target))
            lajurTarikh.appendChild(butang_ubah);

            // Tambahkan setiap sel ke dalam baris.
            baris.appendChild(lajurNama);
            baris.appendChild(lajurAlamat);
            baris.appendChild(lajurAkre);
            baris.appendChild(lajurTarikh);

            // Tambahkan baris yang telah diisi ke dalam badan jadual.
            badanJadual.appendChild(baris);
        });
    }

    function paparkanDataHospital(butangIni) {
        let idHospital = butangIni.dataset.idHospital;
        let dataHospital = dataAsal.filter(hospital => hospital[0] === idHospital)[0];

        ambil("tajukModal").innerHTML = "Kemaskini Data Hospital";

        ambil("namaHospital").value = dataHospital[2];
        ambil("wwwHospital").value = dataHospital[3];
        ambil("wwwPanduan").value = dataHospital[4];
        ambil("alamat").value = dataHospital[5];
        ambil("emel").value = dataHospital[6];
        ambil("telPejabat").value = dataHospital[7];
        ambil("msiso").setAttribute("checked", dataHospital[8]);
        ambil("msqh").setAttribute("checked", dataHospital[9]);

        let butangHantar = ambil("butangHantar");
        butangHantar.dataset.idHospital = dataHospital[0];
        butangHantar.dataset.hospital = "lama";
        butangHantar.dataset.ubat = dataHospital[1];
    }


    async function makanCerna(ubat) {
        let ubatKod = new TextEncoder().encode(ubat);
        let ubatBuffer = await window.crypto.subtle.digest("SHA-256", ubatKod);
        let ubatArray = Array.from(new Uint8Array(ubatBuffer));
        let ubatHex = ubatArray.map((b)=>b.toString(16).padStart(2, "0")).join("");

        return ubatHex;
    }


    function bolehCerna() {
        (window.crypto?.subtle)? alert("Tahniah! Boleh cerna.") : alert("Maaf, akan cirit!");
    }


    async function ambilUbat(ubat) {
        let makanan = await makanCerna(ubat);
        
        return makanan;
    }

    
    // fungsi sementara, cuba-cuba
    function hantar(butangIni) {
        let jenisUrusan = butangIni.dataset.hospital;

        if (jenisUrusan == "lama") {
            let ubat = butangIni.dataset.ubat;
            console.log(ubat);

            ambilUbat(ambil("Kunci").value).then((makanan) => {
                console.log(makanan);
                (ubat == makanan)? alert("Kunci sama") : alert("Kunci tidak sama");
            });
        }
    }


    /**
     * Fungsi success handler yang dipanggil setelah data dari Google Sheets
     * berjaya diterima oleh `google.script.run.ambilData()`. Ia menyimpan data
     * yang diterima ke dalam pembolehubah global `dataAsal` dan kemudian
     * memanggil fungsi `binaJadualDaftarHospital()` untuk memaparkan data
     * dalam bentuk jadual.
     *
     * @param {Array<Array<any>> | undefined} dataDariGS Data yang diterima dari Google Sheets.
     * Struktur data ini sama seperti yang dijelaskan untuk `dataAsal`.
     */
    function simpanData(dataDariGS) {
        bolehCerna();
        // Simpan data yang diterima dari Google Sheets ke dalam pembolehubah global.
        dataAsal = dataDariGS;

        // Bina jadual pendaftaran hospital menggunakan data yang telah disimpan.
        binaJadualDaftarHospital();
    }


    function buat(unsur) {
        return document.createElement(unsur);
    }


    function ambil(id) {
        return document.getElementById(id);
    }
</script>