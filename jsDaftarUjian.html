<script>
    let dataHospital;
    let dataHospitalTerpilih;

    const tunggu = "... Sila tunggu sebentar ...";
    const carianRawak = "Carian anda menjumpai banyak rekod.\n Untuk prestasi terbaik, kami memaparkan ~100 rekod rawak sahaja.\n Sila perincikan carian untuk hasil lebih tepat."
    const tiadaRekod = "Tiada rekod yang sepadan dijumpai.\n Sila cuba terma carian yang berbeza."


    document.addEventListener('DOMContentLoaded', () => {
        ambil("nota").innerHTML = tunggu;
        google.script.run.withSuccessHandler(simpanData).ambilData(2);
    })


    function cariIDhospital() {
        ambil("nota").innerHTML = tunggu;
        let idHospital = ambil("cari").value;
        console.log([idHospital]);

        let dataH = dataHospital.filter(rekod => {return rekod[0] == idHospital});

        if (dataH.length == 1) {
            dataHospitalTerpilih = dataH;
            google.script.run.withSuccessHandler(binaJadualCarian).ambilData(3, [idHospital]);
            console.table(dataHospitalTerpilih);
        } else {
            tungguAlert();
        }
    }


    function cariNamaHospital() {
        let idHospital = [];
        ambil("nota").innerHTML = tunggu;
        let carian = ambil("cari").value.toLowerCase();
        const carianPerkataan = carian.split(/\s+/).filter(perkataan => perkataan);

        let dataH = dataHospital.filter(hospital => {
            let nama = hospital[2].toLowerCase();

            return carianPerkataan.every(perkataan => nama.includes(perkataan));
        });

        if (dataH.length > 0) {
            dataHospitalTerpilih = dataH;

            dataH.forEach(rekod => {idHospital.push(rekod[0])});
            google.script.run.withSuccessHandler(binaJadualCarian).ambilData(3, idHospital);

            console.table(dataHospitalTerpilih);
        } else {
            tungguAlert();
        }
    }


    function cariNamaUjian() {
        ambil("nota").innerHTML = tunggu;
        dataHospitalTerpilih = dataHospital;
        let carian = ambil("cari").value.toLowerCase();
        const carianPerkataan = carian.split(/\s+/).filter(perkataan => perkataan);

        google.script.run.withSuccessHandler(binaJadualCarian).ambilData(4, carianPerkataan);

        console.log(carianPerkataan);
    }


    function binaJadualCarian(dataDariGS) {
        if (dataHospitalTerpilih.length > 1) {

            if (dataDariGS == "Tiada rekod sepadan dijumpai") {
                tungguAlert();
            }

            ambil("nota").innerHTML = carianRawak;
        } else if (dataHospitalTerpilih.length == 1) {
            ambil("nota").innerHTML = "";
        }
        console.table(dataDariGS);
    }


    function simpanData(dataDariGS) {
        dataHospital = dataDariGS;
        console.table(dataHospital);
        ambil("nota").innerHTML = "";
    }


    function tungguAlert() {
        ambil("nota").innerHTML = "";
        alert(tiadaRekod);
    }


    // Dapatkan elemen dari DOM berdasarkan ID
    function ambil(id) {
        return document.getElementById(id);
    }
</script>