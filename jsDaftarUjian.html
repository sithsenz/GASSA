<script>
    let dataHospital;
    let dataHospitalTerpilih;
    let dataUjian;

    const tunggu = "... Sila tunggu sebentar ...";
    const carianRawak = "Carian anda menjumpai banyak rekod.</br> Untuk prestasi terbaik, kami memaparkan ~100 rekod rawak sahaja.</br> Sila perincikan carian untuk hasil lebih tepat."
    const tiadaRekod = "Tiada rekod yang sepadan dijumpai.\n Sila cuba terma carian yang berbeza."


    document.addEventListener('DOMContentLoaded', () => {
        ambil("nota").innerHTML = tunggu;
        google.script.run.withSuccessHandler(simpanData).ambilData(2);
    })


    function cariIDhospital() {
        ambil("nota").innerHTML = tunggu;
        let idHospital = ambil("cari").value;
        console.log([idHospital]);

        let dataH = dataHospital.filter(rekod => {return rekod[0] == idHospital});

        if (dataH.length == 1) {
            dataHospitalTerpilih = dataH;
            google.script.run.withSuccessHandler(binaJadualCarian).ambilData(3, [idHospital]);
            console.table(dataHospitalTerpilih);
        } else {
            tungguAlert();
        }
    }


    function cariNamaHospital() {
        let idHospital = [];
        ambil("nota").innerHTML = tunggu;
        let carian = ambil("cari").value.toLowerCase();
        const carianPerkataan = carian.split(/\s+/).filter(perkataan => perkataan);

        let dataH = dataHospital.filter(hospital => {
            let nama = hospital[2].toLowerCase();

            return carianPerkataan.every(perkataan => nama.includes(perkataan));
        });

        if (dataH.length > 0) {
            dataHospitalTerpilih = dataH;

            dataH.forEach(rekod => {idHospital.push(rekod[0])});
            google.script.run.withSuccessHandler(binaJadualCarian).ambilData(3, idHospital);

            console.table(dataHospitalTerpilih);
        } else {
            tungguAlert();
        }
    }


    function cariNamaUjian() {
        ambil("nota").innerHTML = tunggu;
        dataHospitalTerpilih = dataHospital;
        let carian = ambil("cari").value.toLowerCase();
        const carianPerkataan = carian.split(/\s+/).filter(perkataan => perkataan);

        google.script.run.withSuccessHandler(binaJadualCarian).ambilData(4, carianPerkataan);

        console.table(dataHospitalTerpilih);
        console.log(carianPerkataan);
    }


    function binaJadualCarian(dataDariGS) {
        if (dataDariGS == "Tiada rekod sepadan dijumpai") {
                tungguAlert();
            
        } else {
            if (dataHospitalTerpilih.length == 1) {
            ambil("nota").innerHTML = "";
        
            } else if (dataHospitalTerpilih.length > 1) {
            ambil("nota").innerHTML = carianRawak;
            }

            dataUjian = dataDariGS;

            const badanJadual = ambil("badan-jadual-daftar-ujian");
            badanJadual.innerHTML = "";

            for (rekod of dataUjian) {
                let baris = buat("tr");

                let lajurMakmal = buat("td");
                let lajurUjian = buat("td");
                let lajurKualiti = buat("td");
                let lajurStatus = buat("td");
                let lajurTarikh = buat("td");

                let dataHosp = dataHospitalTerpilih.filter(hosp => {return hosp[0] == rekod[1]});

                if (dataHosp.length == 0) {
                    continue;
                }
                
                lajurMakmal.innerHTML = rekod[1] + "</br>" + dataHosp[0][2];
                
                lajurUjian.innerHTML = rekod[2];

                lajurKualiti.innerHTML = rekod[3] + "</br> [LTAT: " + rekod[4] + "]";

                lajurStatus.innerHTML = rekod[5];

                let butangUbah = buat("button");
                butangUbah.innerHTML = "Ubah";
                butangUbah.dataset.idUjian = rekod[0];
                butangUbah.dataset.ubat = dataHosp[0][1];
                butangUbah.setAttribute("type", "button");
                butangUbah.setAttribute("class", "btn btn-outline-warning");
                butangUbah.setAttribute("data-bs-toggle", "modal");
                butangUbah.setAttribute("data-bs-target", "#modalDaftarUjian");
                butangUbah.addEventListener("click", e => paparkanDataUjian(e.target));



                lajurTarikh.innerHTML = rekod[6] + "</br>";
                lajurTarikh.appendChild(butangUbah);

                baris.appendChild(lajurMakmal);
                baris.appendChild(lajurUjian);
                baris.appendChild(lajurKualiti);
                baris.appendChild(lajurStatus);
                baris.appendChild(lajurTarikh);

                if (rekod[5] == "Digantung") {
                    baris.classList.add("table-danger");
                }

                badanJadual.appendChild(baris);
            };
        }
        
        console.table(dataDariGS);
    }


    function daftarUjian() {
        ambil("tajukModal").innerHTML = "Pendaftaran Ujian Baharu";

        // Kosongkan semua input
        let butiranLama = ambil("modalDaftarUjian").querySelectorAll("input");
        butiranLama.forEach((data) => data.value = "");

        ambil("IDhospital").disabled = false;

        ambil("butangHantar").dataset.ubat = "";
        ambil("butangHantar").dataset.idUjian = "";
        ambil("butangHantar").dataset.urusan = "baru";
        ambil("butangHantar").disabled = true;
    }


    function paparNamaHospital() {
        let idHospital = ambil("IDhospital").value;

        if (idHospital.length < 6) {
            ambil("namaHospital").value = "";
            ambil("butangHantar").disabled = true;
            ambil("butangHantar").dataset.ubat = "";
        } else {
            let hospital = dataHospital.filter(rekod => {return rekod[0] == idHospital});

            if (hospital.length == 1) {
                ambil("namaHospital").value = hospital[0][2];
                ambil("butangHantar").disabled = false;
                ambil("butangHantar").dataset.ubat = hospital[0][1];

            } else {
                ambil("namaHospital").value = "ID Hospital tidak sah";
                ambil("butangHantar").disabled = true;
                ambil("butangHantar").dataset.ubat = "";
            }
        }
    }


    function paparNamaMerujuk() {
        let idHospital = ambil("IDhospitalMerujuk").value;

        if (idHospital.length < 6) {
            ambil("namaHospitalMerujuk").value = "";
            ambil("butangHantarPerjanjian").disabled = true;
            ambil("butangHantarPerjanjian").dataset.ubat = "";
        } else {
            let hospital = dataHospital.filter(rekod => {return rekod[0] == idHospital});

            if (hospital.length == 1) {
                ambil("namaHospitalMerujuk").value = hospital[0][2];
                ambil("butangHantarPerjanjian").disabled = false;
                ambil("butangHantarPerjanjian").dataset.ubat = hospital[0][1];

            } else {
                ambil("namaHospitalMerujuk").value = "ID Hospital tidak sah";
                ambil("butangHantarPerjanjian").disabled = true;
                ambil("butangHantarPerjanjian").dataset.ubat = "";
            }
        }
    }


    function paparkanDataUjian(butangIni) {
        let ubat = butangIni.dataset.ubat;
        let idUjian = butangIni.dataset.idUjian;

        let rekodUjian = dataUjian.filter(rekod => {return rekod[0] == idUjian})[0];
        let rekodHospital = dataHospital.filter(rekod => {return rekod[0] == rekodUjian[1]})[0];

        ambil("tajukModal").innerHTML = "Kemaskini Data Ujian";

        ambil("IDhospital").disabled = true;
        ambil("IDhospital").value = rekodUjian[1];
        ambil("namaHospital").value = rekodHospital[2];
        ambil("namaUjian").value = rekodUjian[2];
        ambil("EQA").value = rekodUjian[3];
        ambil("LTAT").value = rekodUjian[4];
        ambil("statusUjian").value = rekodUjian[5];
        ambil("Kunci").value = "";

        ambil("butangHantar").dataset.ubat = ubat;
        ambil("butangHantar").dataset.idUjian = idUjian;
        ambil("butangHantar").dataset.urusan = "lama";
    }


    async function makanCerna(ubat) {
        let ubatKod = new TextEncoder().encode(ubat.trim());
        let ubatBuffer = await window.crypto.subtle.digest("SHA-256", ubatKod);
        let ubatArray = Array.from(new Uint8Array(ubatBuffer));
        let ubatHex = ubatArray.map((b)=>b.toString(16).padStart(2, "0")).join("");

        return ubatHex;
    }


    function hantar(butangIni) {
        let urusan = butangIni.dataset.urusan;
        let idUjian = butangIni.dataset.idUjian;
        let ubat = butangIni.dataset.ubat;

        let idHospital = ambil("IDhospital").value;
        let namaUjian = ambil("namaUjian").value;
        let EQA = ambil("EQA").value;
        let LTAT = ambil("LTAT").value;
        let statusUjian = ambil("statusUjian").value;
        let tarikh = new Date().toISOString().split("T")[0];
        let kunci = ambil("Kunci").value;

        makanCerna(kunci).then(makanan => {
            if (ubat != makanan) {
                alert("Anda tiada kebenaran untuk mengubah data ujian hospital ini.");

            } else if (urusan == "lama") {
                let dataBaru = [idUjian, idHospital, namaUjian, EQA, LTAT, statusUjian, tarikh];
                ambil("cari").value = idHospital;
                resetUI();
                google.script.run.withSuccessHandler(binaJadualCarian).kemaskiniUjian(dataBaru);

            } else if (urusan == "baru") {
                let dataUjianBaru = ["", idHospital, namaUjian, EQA, LTAT, statusUjian, tarikh];
                ambil("cari").value = idHospital;
                resetUI();
                google.script.run.withSuccessHandler(binaJadualCarian).daftarUjianBaru(dataUjianBaru);
            }
        });


        // Fungsi bantu untuk reset UI
        function resetUI() {
            ambil("nota").innerHTML = tunggu;
            ambil("badan-jadual-daftar-ujian").innerHTML = "";  // Kosongkan jadual
            ambil("butangX").click();  // Tutup modal
        }
    }


    function simpanData(dataDariGS) {
        dataHospital = dataDariGS;
        console.table(dataHospital);
        ambil("nota").innerHTML = "";
    }


    function tungguAlert() {
        ambil("nota").innerHTML = "";
        alert(tiadaRekod);
    }


    // Dapatkan elemen dari DOM berdasarkan ID
    function ambil(id) {
        return document.getElementById(id);
    }


    // Cipta dan kembalikan elemen HTML berdasarkan tag
    function buat(unsur) {
        return document.createElement(unsur);
    }
</script>