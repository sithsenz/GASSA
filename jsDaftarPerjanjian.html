<script>
    /*==================
    1. Pemalar & Tetapan
    ==================*/
    const HOSPITAL = {
        RUJUKAN: "Rujukan",
        MERUJUK: "Merujuk",
    }
    const STATUS_PERJANJIAN = {
        BATAL: "Batal",
        LULUS: "Lulus",
        MOHON: "Mohon",
        TOLAK: "Tolak",
    }
    const NOTA = {
        IDTIDAKSAH: "ID Hospital tidak sah",
        LARANGANLIHAT: "Anda tiada kebenaran untuk melihat rekod perjanjian hospital ini.",
        LARANGANUBAH: "Anda tiada kebenaran untuk mengubah status perjanjian hospital ini.",
        MASUKKUNCI: "Sila masukkan kunci anda",
        TUNGGU: "... Sila tunggu sebentar ...",
    }

    /*============
    2. Pemilih DOM
    ============*/
    const badanJadual = document.getElementById("badan-jadual-perjanjian");
    const inputCarian = {
        butangPapar: document.getElementById("butangPapar"),
        idHospital: document.getElementById("idHospital"),
        namaHospital: document.getElementById("namaHospital"),
        perananHospital: document.getElementById("hospitalSebagai"),
    }
    const namaLajurMakmal = document.getElementById("namaLajurMakmal");
    const nota = document.getElementById("nota");

    /*====================
    3. Persekitaran Global
    ====================*/
    let dataHospital;

    /*==================
    4. Fungsi Utama
    ==================*/
    /**
     * Membina dan memaparkan jadual perjanjian ujian berdasarkan data dari Google Sheets
     * 
     * @param {Array} dataDariGS - Array mengandungi:
     *   [0]: dataPerjanjian - Senarai perjanjian
     *   [1]: dataUjian - Senarai ujian berkaitan
     *   [2]: sebagai - Peranan hospital ("Merujuk" atau "Rujukan")
     * 
     * @description
     * 1. Mengosongkan nota dan badan jadual
     * 2. Menguruskan data:
     *   - Menyusun data perjanjian mengikut:
     *     a) ID Hospital (ascending)
     *     b) Status (descending)
     * 3. Membina baris jadual untuk setiap rekod
     * 
     * @nota
     * - Bergantung pada fungsi binaBarisJadual() untuk pembinaan HTML setiap baris
     * - Mengubah DOM secara langsung melalui badanJadual
     */
    function binaJadualRujukan(dataDariGS) {
        // Kosongkan ruang notifikasi
        nota.innerHTML = "";

        // Dapatkan dan uruskan data
        let dataPerjanjian = dataDariGS[0];

        // Penyusunan data
        dataPerjanjian.sort((a, b) => {
            if (a[1] == b[1]) {  // Jika ID Hospital sama
                return (a[3] < b[3])? 1 : (a[3] > b[3])? -1 : 0;  // Status descending
            } else {
                return (a[1] < b[1])? -1 : (a[1] > b[1])? 1 : 0;  // ID Hospital ascending
            }
        });

        let dataUjian = dataDariGS[1];
        let sebagai = dataDariGS[2];

        // Kosongkan dan bina semula jadual
        badanJadual.innerHTML = "";

        // Tambah setiap rekod sebagai baris jadual
        for (rekod of dataPerjanjian) {
            let baris = binaBarisJadual(rekod, dataUjian, sebagai);
            badanJadual.appendChild(baris);
        }
    }

    function binaBarisJadual(rekod, dataUjian, sebagai) {
        let baris = document.createElement("tr");

        let selMakmal = document.createElement("td");
        let selUjian = document.createElement("td");
        let selStatus = document.createElement("td");
        let selTindakan = document.createElement("td");

        let kumpulanButangMerujuk = ciptaKumpulanButang();
        let butangMohon = ciptaTambahSifatButang("Mohon");
        let butangBatal = ciptaTambahSifatButang("Batal");
        kumpulanButangMerujuk.appendChild(butangMohon);
        kumpulanButangMerujuk.appendChild(butangBatal);

        let kumpulanButangRujukan = ciptaKumpulanButang();
        let butangLulus = ciptaTambahSifatButang("Lulus");
        let butangTolak = ciptaTambahSifatButang("Tolak");
        kumpulanButangRujukan.appendChild(butangLulus);
        kumpulanButangRujukan.appendChild(butangTolak);

        let dataU = dataUjian.find(ujian => {return ujian[0] == rekod[2]});
        let hospitalRujukan = dataHospital.find(hosp => {return hosp[0] == dataU[1]});
        let hospitalMerujuk = dataHospital.find(hosp => {return hosp[0] == rekod[1]});
        let idHospital;
        let namaHospital;

        if (sebagai == HOSPITAL.MERUJUK) {
            idHospital = dataU[1];
            namaHospital = hospitalRujukan[2];
            kumpulanButangRujukan.classList.add("d-none");

        } else if (sebagai == HOSPITAL.RUJUKAN) {
            idHospital = rekod[1];
            namaHospital = hospitalMerujuk[2];
            kumpulanButangMerujuk.classList.add("d-none");
        }

        selMakmal.innerHTML = idHospital + "</br>" + namaHospital;

        let idUjian = rekod[2];
        let namaUjian = dataU[2];
        selUjian.innerHTML = idUjian + "</br>" + namaUjian;

        selStatus.innerHTML = rekod[3] + "</br>" + rekod[4];

        selTindakan.appendChild(kumpulanButangMerujuk);
        selTindakan.appendChild(kumpulanButangRujukan);

        baris.appendChild(selMakmal);
        baris.appendChild(selUjian);
        baris.appendChild(selStatus);
        baris.appendChild(selTindakan);

        if(rekod[3] == STATUS_PERJANJIAN.MOHON) {
            baris.classList.add("table-success");
        } else if (rekod[3] == STATUS_PERJANJIAN.TOLAK) {
            baris.classList.add("table-danger");
        } else if (rekod[3] == STATUS_PERJANJIAN.BATAL) {
            baris.classList.add("table-secondary");
        }

        return baris;
    }

    function hantarTindakan(butangIni) {
        nota.innerHTML = NOTA.TUNGGU;

        let kunci = prompt(NOTA.MASUKKUNCI);

        let idPerjanjian = butangIni.dataset.idPerjanjian;
        let statusPerjanjian = butangIni.innerHTML;
        let idHospital = inputCarian.idHospital.value;
        let sebagai = inputCarian.perananHospital.value;
        let ubat = inputCarian.butangPapar.dataset.ubat;
        let tarikh = new Date().toISOString().split("T")[0];

        makanCerna(kunci).then(makanan => {
            if (ubat != makanan) {
                alert(NOTA.LARANGANUBAH);
                nota.innerHTML = "";
                return;
            }

            google.script.run.withSuccessHandler(binaJadualRujukan).kemaskiniStatusPerjanjian(idPerjanjian, statusPerjanjian, tarikh, idHospital, sebagai);
        });
    }

    function paparPerjanjian() {
        nota.innerHTML = NOTA.TUNGGU;

        let idHospital = inputCarian.idHospital.value;
        let sebagai = inputCarian.perananHospital.value;
        let ubat = inputCarian.butangPapar.dataset.ubat;

        resetLajurNamaMakmal();

        let kunci = prompt(NOTA.MASUKKUNCI);

        makanCerna(kunci).then(makanan => {
            if (ubat != makanan) {
                alert(NOTA.LARANGANLIHAT);
                nota.innerHTML = "";
                return;
            }
            
            if (sebagai == HOSPITAL.MERUJUK) {
                google.script.run.withSuccessHandler(binaJadualRujukan).ambilData(5, idHospital);

            } else if (sebagai == HOSPITAL.RUJUKAN) {
                google.script.run.withSuccessHandler(binaJadualRujukan).ambilData(6, idHospital);
            }
        });
    }

    /*===============
    5. Fungsi Utiliti
    ===============*/
    async function makanCerna(ubat) {
        let ubatKod = new TextEncoder().encode(ubat.trim());
        let ubatBuffer = await window.crypto.subtle.digest("SHA-256", ubatKod);
        let ubatArray = Array.from(new Uint8Array(ubatBuffer));
        let ubatHex = ubatArray.map((b)=>b.toString(16).padStart(2, "0")).join("");

        return ubatHex;
    }

    function paparNamaHospital() {
        let idHospital = inputCarian.idHospital.value;

        if (idHospital.length < 6) {
            inputCarian.namaHospital.value = "";
            inputCarian.butangPapar.dataset.ubat = "";
            inputCarian.butangPapar.disabled = true;

        } else {
            let hospital = dataHospital.find(rekod => {return rekod[0] == idHospital});

            if (hospital != undefined) {
                inputCarian.namaHospital.value = hospital[2];
                inputCarian.butangPapar.dataset.ubat = hospital[1];
                inputCarian.butangPapar.disabled = false;
            
            } else {
                inputCarian.namaHospital.value = NOTA.IDTIDAKSAH;
                inputCarian.butangPapar.dataset.ubat = "";
                inputCarian.butangPapar.disabled = true;
            }
        }
    }

    function simpanData(dataDariGS) {
        dataHospital = dataDariGS;
        nota.innerHTML = "";
    }

    function resetLajurNamaMakmal() {
        let hospitalSebagai = inputCarian.perananHospital.value;
        namaLajurMakmal.innerHTML = hospitalSebagai == HOSPITAL.MERUJUK? "Nama Makmal Rujukan" : "Nama Makmal Merujuk";
    }

    function ciptaTambahSifatButang(namaButang) {
        let butang = document.createElement("button");
        butang.setAttribute("type", "button");
        butang.classList.add("btn", "btn-outline-warning");
        butang.dataset.idPerjanjian = rekod[0];
        butang.addEventListener("click", e => hantarTindakan(e.target));
        butang.innerHTML = namaButang;

        return butang;
    }

    function ciptaKumpulanButang() {
        let kumpulan = document.createElement("div");
        kumpulan.classList.add("btn-group", "btn-group-sm");
        kumpulan.setAttribute("role", "group");

        return kumpulan;
    }

    /*==============
    6. Permulaan DOM
    ==============*/
    document.addEventListener('DOMContentLoaded', () => {
        nota.innerHTML = NOTA.TUNGGU;
        google.script.run.withSuccessHandler(simpanData).ambilData(2);
    })
</script>