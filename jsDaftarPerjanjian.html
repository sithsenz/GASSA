<script>
    let dataHospital;

    const tunggu = "... Sila tunggu sebentar ...";


    document.addEventListener('DOMContentLoaded', () => {
        ambil("nota").innerHTML = tunggu;
        google.script.run.withSuccessHandler(simpanData).ambilData(2);
    })


    function binaJadualRujukan(dataDariGS) {
        ambil("nota").innerHTML = "";

        let dataPerjanjian = dataDariGS[0];
        let dataUjian = dataDariGS[1];
        let sebagai = dataDariGS[2];

        let badanJadual = ambil("badan-jadual-perjanjian");
        badanJadual.innerHTML = "";

        for (rekod of dataPerjanjian) {
            let baris = buat("tr");

            let selMakmal = buat("td");
            let selUjian = buat("td");
            let selStatus = buat("td");
            let selTindakan = buat("td");

            let kumpulanButangMerujuk = buat("div");
            kumpulanButangMerujuk.classList.add("btn-group")
            kumpulanButangMerujuk.setAttribute("role", "group");
            let butangPermohonan = buat("button");
            let butangPembaharuan = buat("button");
            let butangPembatalan = buat("button");
            butangPermohonan.setAttribute("type", "button");
            butangPermohonan.classList.add("btn", "btn-outline-warning");
            butangPermohonan.innerHTML = "Permohonan";
            butangPembaharuan.setAttribute("type", "button");
            butangPembaharuan.classList.add("btn", "btn-outline-warning");
            butangPembaharuan.innerHTML = "Pembaharuan";
            butangPembatalan.setAttribute("type", "button");
            butangPembatalan.classList.add("btn", "btn-outline-warning");
            butangPembatalan.innerHTML = "Pembatalan";
            kumpulanButangMerujuk.appendChild(butangPermohonan);
            kumpulanButangMerujuk.appendChild(butangPembaharuan);
            kumpulanButangMerujuk.appendChild(butangPembatalan);

            let kumpulanButangRujukan = buat("div");
            kumpulanButangRujukan.classList.add("btn-group")
            kumpulanButangRujukan.setAttribute("role", "group");
            let butangLulus = buat("button");
            let butangKajiSemula = buat("button");
            let butangTangguh = buat("button");
            butangLulus.setAttribute("type", "button");
            butangLulus.classList.add("btn", "btn-outline-warning");
            butangLulus.innerHTML = "Lulus";
            butangKajiSemula.setAttribute("type", "button");
            butangKajiSemula.classList.add("btn", "btn-outline-warning");
            butangKajiSemula.innerHTML = "Kaji Semula";
            butangTangguh.setAttribute("type", "button");
            butangTangguh.classList.add("btn", "btn-outline-warning");
            butangTangguh.innerHTML = "Tangguh";
            kumpulanButangRujukan.appendChild(butangLulus);
            kumpulanButangRujukan.appendChild(butangKajiSemula);
            kumpulanButangRujukan.appendChild(butangTangguh);

            let dataU = dataUjian.filter(ujian => {return ujian[0] == rekod[2]});
            let hospitalRujukan = dataHospital.filter(hosp => {return hosp[0] == dataU[0][1]});
            let hospitalMerujuk = dataHospital.filter(hosp => {return hosp[0] == rekod[1]});
            let idHospital;
            let namaHospital;

            if (sebagai == "Merujuk") {
                idHospital = dataU[0][1];
                namaHospital = hospitalRujukan[0][2];

            } else if (sebagai == "Rujukan") {
                idHospital = rekod[1];
                namaHospital = hospitalMerujuk[0][2];
            }

            selMakmal.innerHTML = idHospital + "</br>" + namaHospital;

            let idUjian = rekod[2];
            let namaUjian = dataU[0][2];
            selUjian.innerHTML = idUjian + "</br>" + namaUjian;

            selStatus.innerHTML = rekod[3] + "</br>" + rekod[4];

            selTindakan.appendChild(kumpulanButangMerujuk);
            selTindakan.appendChild(kumpulanButangRujukan);

            baris.appendChild(selMakmal);
            baris.appendChild(selUjian);
            baris.appendChild(selStatus);
            baris.appendChild(selTindakan);

            badanJadual.appendChild(baris);
        }
    }


    function paparPerjanjian() {
        ambil("nota").innerHTML = tunggu;

        let idHospital = ambil("idHospital").value;
        let sebagai = ambil("hospitalSebagai").value;
        let ubat = ambil("butangPapar").dataset.ubat;

        resetLajurNamaMakmal();

        let kunci = prompt("Sila masukkan kunci anda");

        makanCerna(kunci).then(makanan => {
            if (ubat != makanan) {
                alert("Anda tiada kebenaran untuk melihat rekod perjanjian hospital ini.");
                ambil("nota").innerHTML = "";

            } else if (sebagai == "Merujuk") {
                google.script.run.withSuccessHandler(binaJadualRujukan).ambilData(5, idHospital);

            } else if (sebagai == "Rujukan") {
                google.script.run.withSuccessHandler(binaJadualRujukan).ambilData(6, idHospital);
            }
        });
    }


    async function makanCerna(ubat) {
        let ubatKod = new TextEncoder().encode(ubat.trim());
        let ubatBuffer = await window.crypto.subtle.digest("SHA-256", ubatKod);
        let ubatArray = Array.from(new Uint8Array(ubatBuffer));
        let ubatHex = ubatArray.map((b)=>b.toString(16).padStart(2, "0")).join("");

        return ubatHex;
    }


    function paparNamaHospital() {
        let idHospital = ambil("idHospital").value;

        if (idHospital.length < 6) {
            ambil("namaHospital").value = "";
            ambil("butangPapar").dataset.ubat = "";
            ambil("butangPapar").disabled = true;

        } else {
            let hospital = dataHospital.filter(rekod => {return rekod[0] == idHospital});

            if (hospital.length == 1) {
                ambil("namaHospital").value = hospital[0][2];
                ambil("butangPapar").dataset.ubat = hospital[0][1];
                ambil("butangPapar").disabled = false;
            
            } else {
                ambil("namaHospital").value = "ID Hospital tidak sah";
                ambil("butangPapar").dataset.ubat = "";
                ambil("butangPapar").disabled = true;
            }
        }
    }


    function simpanData(dataDariGS) {
        dataHospital = dataDariGS;
        ambil("nota").innerHTML = "";
    }


    function resetLajurNamaMakmal() {
        let namaLajurMakmal = ambil("namaLajurMakmal");
        let hospitalSebagai = ambil("hospitalSebagai").value;
        namaLajurMakmal.innerHTML = hospitalSebagai == "Merujuk"? "Nama Makmal Rujukan" : "Nama Makmal Merujuk";
    }


    // Dapatkan elemen dari DOM berdasarkan ID
    function ambil(id) {
        return document.getElementById(id);
    }


    // Cipta dan kembalikan elemen HTML berdasarkan tag
    function buat(unsur) {
        return document.createElement(unsur);
    }
</script>